@using Microsoft.AspNetCore.SignalR.Client
@model List<RideModel>
@using Infrastructure.Enums
@Html.AntiForgeryToken()

<input type="hidden" id="currentUsername" value="@User.Identity.Name" />
@{
    
    if (Model != null && Model.Any())
    {
        foreach (var ride in Model)
        {
            var statusClass = ride.BookingStatus == BookingStatus.Confirmed
             ? "bg-green-100"
             : ride.BookingStatus == BookingStatus.Pending
                 ? "bg-orange-100"
                 : ride.BookingStatus == BookingStatus.Completed
                     ? "bg-green-400"
                     
             : "bg-secondary-100";

            <div class="driver-ride-item-section @statusClass">
                <div class="driver-ride-item">
                    <button class="btn-message bottom-0 end-0 m-2"
                            id="chatButton-@ride.Id"
                            data-ride-id="@ride.Id"
                            data-receiver="@ride.DriverId"
                            onclick="toggleChat(this)"
                            title="Visa chat">
                        <i style="color:@(ride.HasUnreadMessages ? "#636363" : "#636363")" class="fa-solid fa-comment-dots"></i>
                        <span id="unreadBadge-@ride.Id" class="badge-unread" style="display:none;">0</span>
                    </button>

                    <div class="ride-info">
                        <p class="date">@ride.DepartureTime.ToShortDateString()</p>
                        <div class="destination-info">
                            <div class="circle-container">
                                <i class="fa-solid fa-circle circle"></i>
                                <div class="line"></div>
                                <i class="fa-solid fa-circle circle"></i>
                            </div>
                            <div class="text">
                                <p><span class="time">@ride.DepartureTime.ToString("HH:mm")</span> &nbsp; @ride.Origin </p>
                                <span class="duration">1h 15m</span>
                                <p><span class="time">@ride.DepartureTime.ToString("HH:mm")</span> &nbsp; @ride.Destination </p>
                            </div>
                        </div>
                    </div>

                    <div class="price-status">
                        <div class="price">
                            @if (ride.Free)
                            {
                                <p class="free">Gratis</p>
                            }
                            else
                            {
                                <p>@ride.Price kr</p>
                            }
                        </div>

                        <div class="ride-status">
                            @switch (ride.BookingStatus)
                            {
                                case BookingStatus.Pending:
                                    <span class="badge bg-warning text-dark">Förfrågan</span>
                                    <button type="button" class="btn btn-transparent-accent-orange" data-bs-toggle="modal" data-bs-target="#bookingModal" onclick="loadBookingInfo('@ride.Id')">Bokningsinformation</button>

                                    <form asp-controller="Booking" asp-action="Confirm" method="post">
                                        <input type="hidden" name="bookingId" value="@ride.Id" />
                                        <button type="submit" class="btn btn-success"><i class="fa-solid fa-circle-check"></i></button>
                                    </form>

                                    <form asp-controller="Booking" asp-action="Cancel" method="post">
                                        <input type="hidden" name="bookingId" value="@ride.Id" />
                                        <button type="submit" class="btn btn-danger"><i class="fa-solid fa-circle-xmark"></i></button>
                                    </form>
                                    break;

                                case BookingStatus.Confirmed:
                                    <span class="badge bg-success">Bekräftad</span>
                                    <button type="button" class="btn btn-transparent-accent-orange" data-bs-toggle="modal" data-bs-target="#bookingModal" onclick="loadBookingInfo('@ride.Id')">Bokningsinformation</button>

                                    <form asp-controller="Booking" asp-action="Complete" method="post">
                                        <input type="hidden" name="bookingId" value="@ride.Id" />
                                        <button type="submit" class="btn btn-primary">Slutför</button>
                                    </form>

                                    break;

                                case BookingStatus.NotBooked:
                                    <form asp-controller="Rides" asp-action="Delete" method="post" class="delete-button top-0 end-0 m-2">
                                        <input type="hidden" name="rideId" value="@ride.Id" />
                                        <button type="submit" class="btn btn-sm" title="Ta bort resa">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </form>
                                    <span class="badge bg-secondary">Ej bokad</span>
                                    break;
                                case BookingStatus.Completed:
                                    <form asp-controller="Rides" asp-action="Delete" method="post" class="delete-button top-0 end-0 m-2">
                                        <input type="hidden" name="rideId" value="@ride.Id" />
                                        <button type="submit" class="btn btn-sm" title="Ta bort resa">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </form>
                                    <span class="badge bg-success">Avslutad</span>
                                    break;

                                default:
                                    <span class="badge bg-info">Unknown Status</span>
                                    break;
                            }
                        </div>
                    </div>
                </div>

                <div id="rideChat-@ride.Id" class="ride-messages" style="display: none;">
                    <div id="messagesBox-@ride.Id" class="messages-box">
                        @if (ride.Messages != null && ride.Messages.Any())
                        {
                            foreach (var msg in ride.Messages)
                            {
                                <div class="message-item">
                                    <strong>@msg.Sender:</strong> @msg.Text
                                    <div class="timestamp">@msg.Timestamp.ToString("g")</div>
                                </div>
                            }
                        }
                    </div>
                    <form onsubmit="sendMessage(event, '@ride.Id')">
                        <input type="text" id="messageText-@ride.Id" placeholder="Skriv ett meddelande..." required />
                        <button type="submit" class="btn-gray">Skicka</button>
                    </form>
                </div>


            </div>
            

            
        }
    }
}

<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Bokningsinformation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bookingInfo">
                Loading...
            </div>
        </div>
    </div>
</div>


<script>
    function loadBookingInfo(rideId) {
        console.log("Loading booking info for ride ID: " + rideId);

        $.ajax({
            url: `/Booking/GetBookingInfo?rideId=${rideId}`,
            method: "GET",
            success: function (data) {
                if (data && data.passengerName) {
                    $('#bookingInfo').html(`
                            <p><strong>Passagerarnamn:</strong> ${data.passengerName}</p>
                            <p><strong>Kontakt:</strong> ${data.contact || 'N/A'}</p>
                            <p><strong>Antal platser:</strong> ${data.numberOfSeats}</p>
                            <p><strong>Meddelande:</strong> ${data.message}</p>
                        `);
                } else {
                    $('#bookingInfo').html('<p>No booking info available.</p>');
                }
                var modalElement = document.getElementById('bookingModal');
                var modal = new bootstrap.Modal(modalElement);
                modal.show();
                $('.modal-backdrop').remove();
            },
            error: function () {
                $('#bookingInfo').html('<p>Error loading booking information.</p>');
            }
        });
    }

</script>

<script src="~/js/chatbox-driver-passenger.js"></script>

<script src="~/js/init-unread-badges-driver.js"></script>




