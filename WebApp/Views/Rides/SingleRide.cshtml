@using Microsoft.AspNetCore.SignalR.Client
@model RideModel

<section id="single-ride">
     <div class="container">
		@await Html.PartialAsync("~/Views/Shared/Sections/_StatusMessage.cshtml")
		<div class="ride-content">
			<p>Avgångstid: <span>@Model.DepartureTime.ToString("dd MMM yyyy")</span> <span class="time">@Model.DepartureTime.ToString("HH:mm")</span> </p>
			<div class="ride-info">
				<div class="destination-info">
					<p>@Model.Origin</p>
					<i class="fa-solid fa-arrow-right"></i>
					<p>@Model.Destination</p>
				</div>

				<div class="driver-info">

					@if (Model.UserImgUrl != null)
					{
						<img src="~/images/uploads/profiles/@Model.UserImgUrl" />
					}
					else
					{
						<img src="~/images/uploads/profiles/avatar.svg" />
					}
					<p>@Model.DriverName</p>

					<button class="btn-chat" type="button" onclick="toggleChat()" title="Öppna meddelanden">
						<i class="fa-regular fa-comment"></i>
					</button>

					
				</div>
				
				

			</div>

			
			@if (Model.Free)
			{
				<p class="free">Pris:<span>Gratis</span></p>
			}
			else
			{
				<p class="price">Pris:<span>@Model.Price kr</span></p>
			}
			
			<p class="seats">Tillgängliga platser: <span>@Model.AvailableSeats</span></p>
			<p class="details">Resedetaljer: <span>@Model.TripDetails</span></p>
			<div class="booking">
				<form method="post" asp-controller="Rides" asp-action="Booking">
					<div class="content">
						<div id="form-seat">
							<label asp-for="@Model.RequiredSeats"></label>
							<input asp-for="@Model.RequiredSeats" />
						</div>
						<div id="form-message" class="input-group">
							<label asp-for="@Model.PassangerMessage"></label>
							<input asp-for="@Model.PassangerMessage" />
						</div>
						<input type="hidden" asp-for="@Model.Id" />
						<input type="hidden" asp-for="@Model.Origin" />
						<input type="hidden" asp-for="@Model.DriverName" />
						<input type="hidden" asp-for="@Model.Destination" />
						
					</div>
					<button id="form-button" class="btn-accent-yellow" type="submit">Boka</button>
				</form>
				
			</div>
		
		</div>
				
		<div id="rideChat" class="ride-messages" style="display: none;">
			<div id="messagesBox" class="messages-box">
				@if (Model.Messages != null && Model.Messages.Any())
				{
					foreach (var msg in Model.Messages)
					{
						<div class="message-item">
							<strong>@msg.Sender:</strong> @msg.Text
							<div class="timestamp">@msg.Timestamp.ToString("g")</div>
						</div>
					}
				}
				
			</div>
			<form id="chatForm" onsubmit="sendMessage(event)">
				<input type="text" id="messageText" placeholder="Skriv ett meddelande..." required />
				<button type="submit" class="btn-gray">Skicka</button>
			</form>
		
		</div>
    </div>
    
</section>


<script>
	const rideId = "@Model.Id";
	const sender = "@User.Identity.Name";
	const receiver = "@Model.DriverId";
	
	function toggleChat() {
		const chatBox = document.getElementById("rideChat");
		chatBox.style.display = chatBox.style.display === "none" ? "block" : "none";
	}
</script>

<script src="~/js/chatbox.js"></script>

